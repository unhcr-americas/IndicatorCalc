---
title: "Development"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{development}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(IndicatorCalc)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/indicators.Rmd: do not edit by hand -->

<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->


# Data Wrangling

Each indicator calculation is based on predefined frame, variable name and variable value.

Therefore each indicator function is organised in 3  steps:

 * Check if the standard frame/variable/modalities are already present in the dataset (organised as a list..) `fct_check_map`
 
 * If not apply the mapping supplied as argument within the function `fct_re_map`
 
 * Apply the calculation - either to append the new variable to the existing data or to output just the final vector with results. 
 

## fct_check_map

  

```{r example-fct_check_map}

mapper = list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c("Does this household use anything for lighting?",
                        "What source of electricity is used most of the time in this household?"),
              variable = c("LIGHT01", 
                           "LIGHT03"),
              mappattern = c("LIGHT01", 
                           "LIGHT03") ),
            modalitymap = data.frame(
              variable = c( "LIGHT01", 
                            "LIGHT03", "LIGHT03", "LIGHT03"),
              label = c( "yes",
                        "No electricity in household", "Other, specify", "Don't know"),
              standard = c( "1",
                           "1", "96", "98"),
              map = c("1",
                      "1", "96", "98")
            )
          )

## Correct format
data <- list(main = data.frame(
                LIGHT01 = c("1",  "1",  "0", "1",  "1",  "0", "1",  "1",  "1"),
                LIGHT03 = c("1", "96", "98", "1", "96", "98", "0", "96", "98"))
             )
fct_check_map(datalist = data, mapper = mapper )

## One variable is not correctly 
data <- list(main = data.frame(
                LIGHT01 = c("1",  "1",  "0", "1",  "1",  "0", "1",  "1",  "1"),
                LIGH03 = c("1", "96", "98", "1", "96", "98", "0", "96", "98"))
             )
fct_check_map(datalist = data, mapper = mapper )

## The first variable does not include a single 1...
data <- list(main = data.frame(
                LIGHT01 = c("0",  "0",  "0", "0",  "0",  "0", "0",  "0",  "0"),
                LIGHT03 = c("1", "96", "98", "1", "96", "98", "0", "96", "98"))
             )
fct_check_map(datalist = data, mapper = mapper )
```

  

## fct_get_all_variable_names

    

  

```{r example-fct_get_all_variable_names}
data <- kobocruncher::kobo_data( system.file("test.xlsx",
                                             package = "IndicatorCalc"))
varname <-   fct_get_all_variable_names(datalist = data)
head(varname, 10)
```

  

## fct_re_map

    

  

```{r example-fct_re_map}
mapper = list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c("Does this household use anything for lighting?",
                        "What source of electricity is used most of the time in this household?"),
              variable = c("LIGHT01", 
                           "LIGHT03"),
              mappattern = c("LIGHT01", 
                           "LIGHT03") ),
            modalitymap = data.frame(
              variable = c( "LIGHT01", 
                            "LIGHT03", "LIGHT03", "LIGHT03"),
              label = c( "yes",
                "No electricity in household", "Other, specify", "Don't know"),
              standard = c( "1",
                           "1", "96", "98"),
              map = c("yes",
                      "Noelec", "Other", "Dontknow")
            )
          )


## One variable is not correctly 
datalist <- list(mainhousehold = data.frame(
                group.LIGHT01 = c("yes",  "yes",  "no", "yes",  "yes",
                                  "no", "yes",  "yes",  "yes"),
                group.LIGHT03 = c("Noelec", "Other", "Dontknow", "Noelec", "Other",
                                  "Dontknow", "Nuclear", "Other", "Dontknow"))
             )
datalist <- fct_re_map(datalist = datalist, mapper = mapper )

fct_check_map(datalist = datalist, mapper = mapper )
 

```

  

## fct_plot_indic_donut

    

  

```{r example-fct_plot_indic_donut}
test <- data.frame(
  shelter = rbinom(20, 1, 0.5)) |> 
  dplyr::mutate( shelter = 
  labelled::labelled( shelter,
                      labels = c( "Yes" = 1, "No" = 0),
                      label = "Access to adequate shelter")) 
  
fct_plot_indic_donut(indicator = test$shelter,
                     subtitle_chart = NULL,
                     caption_chart = NULL,
                     ordered_threhold = NULL,
                     iconunicode = "e54f") 
```

  

  



# Impact Indicators

 

## inter_electricity

    

  

```{r example-inter_electricity}
datalist <- kobocruncher::kobo_data( system.file("test.xlsx", 
                                                 package = "IndicatorCalc"))
mapper <- list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c("Does this household use anything for lighting?",
       "What source of electricity is used most of the time in this household?"),
              variable = c("LIGHT01", 
                           "LIGHT03"),
              mappattern = c("LIGHT01", 
                           "LIGHT03") ),
            modalitymap = data.frame(
              variable = c( "LIGHT01", 
                            "LIGHT03", "LIGHT03", "LIGHT03"),
              label = c( "yes",
                        "No electricity in household", "Other, specify", "Don't know"),
              standard = c( "1",
                           "1", "96", "98"),
              map = c("yes",
                      "1", "96", "98"))) 

datalist <- inter_electricity( datalist =datalist, mapper = mapper  )


table(datalist[["main"]]$electricity)
fct_plot_indic_donut(indicator = datalist[["main"]]$electricity,
                     iconunicode = "f0e7") 

```

  

  

## inter_healthcare

    

  

```{r example-inter_healthcare}
datalist <- kobocruncher::kobo_data( system.file("test.xlsx",
                                                 package = "IndicatorCalc"))

mapper <-  list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c(
"In general, when anyone in your household is sick, where do they go to seek care?",
"How long it takes to go there when you use the mode of transport mentioned above?"),
              variable = c("HEA01", 
                           "HEA03"),
              mappattern = c("HEA01", 
                           "HEA03") ),
            modalitymap = data.frame(
              variable = c( "HEA01", "HEA01" ),
              label = c(  "Other, specify", "Don't know"),
              standard = c("96", "98" ),
              map = c("96", "98" )))

datalist <- inter_healthcare(datalist, mapper )

table(datalist[["main"]]$healthcare)
fct_plot_indic_donut(indicator = datalist[["main"]]$healthcare,
                     iconunicode = "f479") 

```

  

## inter_drinkingwater

    

  

```{r example-inter_drinkingwater}
datalist <- kobocruncher::kobo_data( system.file("test.xlsx",
                                                 package = "IndicatorCalc"))

## in the contextualised form - DWA03a has been skipped and all results are in min... 
## only manual transformation can adjust this before we use the mapper..

datalist[["main"]]$DWA03a  <- "1" 

datalist[["main"]]$DWA03b <- 
  datalist[["main"]]$VulnerabilityScoring.BasicNeeds.DWA03

# now the mapper
mapper <-  list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c(
   "What is the main source of drinking water for this household?",
  "Where is this source located?",
  "Unit used to measure time to access",
  "How long does it take to go there, wait get water, and come back?"),
              variable = c("DWA01", 
                           "DWA02", 
                           "DWA03a", 
                           "DWA03b" ),
              mappattern = c("DWA01", 
                           "DWA02", 
                           "DWA03a", 
                           "DWA03b" ) ),
            modalitymap = data.frame(
             variable = c("DWA01",  "DWA01", "DWA01","DWA01",  "DWA01", 
                   "DWA02","DWA02", "DWA02",
                   "DWA03a","DWA03a"),
             label = c( 
                ##DWA01
                "Unprotected Dug Well", 
                "Unprotected Spring",
                "Surface Water (River, Stream, Pond, Dam, Canal)",
                "Other, specify",
                "Don't know",
                ##DWA02
                "In Own Dwelling", 
                "In Own Yard/Plot",
                "Elsewhere",
                ## DWA03a
                "Minutes", 
                "Hours"    ),
             standard = c( "7", "9", "13", "96", "98",
                           "1", "2", "3",
                           "1", "2"),
             map = c( "7", "9", "13", "96", "98",
                       "1", "2", "3",
                        "1", "2") ) 
         )
  
datalist <- inter_drinkingwater(datalist, mapper )

## Indicator summary
table(datalist[["main"]]$drinkingwater, useNA = "ifany")
fct_plot_indic_donut(indicator = datalist[["main"]]$drinkingwater,
                     iconunicode = "e006") 

## Check auxilliary
table(datalist[["main"]]$dwa_cond1, useNA = "ifany")
table(datalist[["main"]]$reachableU30, useNA = "ifany")
table(datalist[["main"]]$DWA02, useNA = "ifany")
table(datalist[["main"]]$dwa_cond2, useNA = "ifany")
```

  

## inter_shelter

    

  

```{r example-inter_shelter}
datalist <- kobocruncher::kobo_data( system.file("test.xlsx", 
                                                 package = "IndicatorCalc"))

mapper <- list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c(
                "What type of dwelling does the household live in?",
"Main material of the dwelling floor",
"Main material of the roof",
"Main material of the exterior walls",
"How many separate rooms do the members of your household occupy?",
"What is the total number of persons in this household?"),
              variable = c("DWE01","DWE02","DWE03","DWE04","DWE05", 
                           "HH01"),
              mappattern = c("DWE01","DWE02","DWE03","DWE04","DWE05", 
                           "progres_groupsize") ),
            modalitymap = data.frame(
              variable = c( "DWE01","DWE01",
                            "DWE02","DWE02","DWE02",
                            "DWE03","DWE03","DWE03","DWE03","DWE03","DWE03",
                            "DWE04","DWE04","DWE04","DWE04","DWE04","DWE04"),
              label = c(  "Apartment", "House", # DWE01
                         "Earth/sand", "Dung", "Other (Specify)", #DWE02
                         
                         "Metal/tin", "Wood", "Calamine/Cement fibre", 
                         "Ceramic tiles", "Cement", "Roofing shingles",#DWE03
                         
                         "Cement", "Stone with lime/ cement", "Bricks", 
                         "Cement blocks", "Covered adobe", "Wood planks/shingles" # DWE04
                         ),
              standard = c( "1","2",
                           "1", "2","96",
                           "8","9","10","11","12","13",
                           "10","11","12","13","14","15"),
              map = c("1","2",
                           "1", "2","96",
                           "8","9","10","11","12","13",
                           "10","11","12","13","14","15"))) 
## Calculate
datalist <-  inter_shelter(datalist, mapper)
# Tabulate
table(datalist[["main"]]$dwe01_cat)
table(datalist[["main"]]$dwe02_cat)
table(datalist[["main"]]$dwe03_cat)
table(datalist[["main"]]$dwe04_cat)
table(datalist[["main"]]$dwe05_cat)
table(datalist[["main"]]$shelter)
#plot
fct_plot_indic_donut(datalist[["main"]]$shelter,
                     iconunicode = "e54f") 
```

  

  


## impact_2_2 

    

  

```{r example-impact_2_2}
datalist <- kobocruncher::kobo_data( system.file("test.xlsx",
                                                 package = "IndicatorCalc"))

#Healthcare
mapper <-  list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c(
  "In general, when anyone in your household is sick, 
   where do they go to seek care?",
  "How long does it take to go there when you use the mode of transport 
  that you mentioned above?"),
              variable = c("HEA01", 
                           "HEA03"),
              mappattern = c("HEA01", 
                           "HEA03") ),
            modalitymap = data.frame(
              variable = c( "HEA01", "HEA01" ),
              label = c(  "Other, specify", "Don't know"),
              standard = c("96", "98" ),
              map = c("96", "98" )))

datalist <- inter_healthcare(datalist, mapper )

## Electricity
mapper <- list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c("Does this household use anything for lighting?",
       "What source of electricity is used most of the time in this household?"),
              variable = c("LIGHT01", 
                           "LIGHT03"),
              mappattern = c("LIGHT01", 
                           "LIGHT03") ),
            modalitymap = data.frame(
              variable = c( "LIGHT01", 
                            "LIGHT03", "LIGHT03", "LIGHT03"),
              label = c( "yes",
                        "No electricity in household", "Other, specify", "Don't know"),
              standard = c( "1",
                           "1", "96", "98"),
              map = c("yes",
                      "1", "96", "98"))) 

datalist <- inter_electricity( datalist =datalist, mapper = mapper  )

## Drinking Water
## in the contextualised form - DWA03a has been skipped and all results are in min... 
## only manual transformation can adjust this before we use the mapper..

datalist[["main"]]$DWA03a  <- "1" 

datalist[["main"]]$DWA03b <- 
  datalist[["main"]]$VulnerabilityScoring.BasicNeeds.DWA03

# now the mapper
mapper <-  list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c(
               "What is the main source of drinking water for this household?",
               "Where is this source located?",
               "Unit used to measure time to access",
               "How long does it take to go there, get water, and come back,
                including waiting time?"),
              variable = c("DWA01", 
                           "DWA02", 
                           "DWA03a", 
                           "DWA03b" ),
              mappattern = c("DWA01", 
                           "DWA02", 
                           "DWA03a", 
                           "DWA03b" ) ),
            modalitymap = data.frame(
             variable = c("DWA01",  "DWA01", "DWA01","DWA01",  "DWA01", 
                   "DWA02","DWA02", "DWA02",
                   "DWA03a","DWA03a"),
             label = c( 
                ##DWA01
                "Unprotected Dug Well", 
                "Unprotected Spring",
                "Surface Water (River, Stream, Pond, Dam, Canal)",
                "Other, specify",
                "Don't know",
                ##DWA02
                "In Own Dwelling", 
                "In Own Yard/Plot",
                "Elsewhere",
                ## DWA03a
                "Minutes", 
                "Hours"    ),
             standard = c( "7", "9", "13", "96", "98",
                           "1", "2", "3",
                           "1", "2"),
             map = c( "7", "9", "13", "96", "98",
                       "1", "2", "3",
                        "1", "2") ) 
         )
  
datalist <- inter_drinkingwater(datalist, mapper )

##Shelter
mapper <- list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c(
                "What type of dwelling does the household live in?",
"Main material of the dwelling floor",
"Main material of the roof",
"Main material of the exterior walls",
"How many separate rooms do the members of your household occupy?",
"What is the total number of persons in this household?"),
              variable = c("DWE01","DWE02","DWE03","DWE04","DWE05", 
                           "HH01"),
              mappattern = c("DWE01","DWE02","DWE03","DWE04","DWE05", 
                           "progres_groupsize") ),
            modalitymap = data.frame(
              variable = c( "DWE01","DWE01",
                            "DWE02","DWE02","DWE02",
                            "DWE03","DWE03","DWE03","DWE03","DWE03","DWE03",
                            "DWE04","DWE04","DWE04","DWE04","DWE04","DWE04"),
              label = c(  "Apartment", "House", # DWE01
                         "Earth/sand", "Dung", "Other (Specify)", #DWE02
                         
                         "Metal/tin", "Wood", "Calamine/Cement fibre", 
                         "Ceramic tiles", "Cement", "Roofing shingles",#DWE03
                         
                         "Cement", "Stone with lime/ cement", "Bricks", 
                         "Cement blocks", "Covered adobe", "Wood planks/shingles" # DWE04
                         ),
              standard = c( "1","2",
                           "1", "2","96",
                           "8","9","10","11","12","13",
                           "10","11","12","13","14","15"),
              map = c("1","2",
                           "1", "2","96",
                           "8","9","10","11","12","13",
                           "10","11","12","13","14","15"))) 
## Calculate
datalist <-  inter_shelter(datalist, mapper)

## and now impact

mapper <-   list(
            hierarchy = "main",
            variablemap = data.frame(
              label = c("Access to shelter", 
                        "Access to electricity", 
                         "Access to drinking water", 
                         "Access to  healthcare"),
              variable = c("shelter", 
                           "electricity", 
                           "drinkingwater", 
                           "healthcare"),
              mappattern = c("shelter", 
                           "electricity", 
                           "drinkingwater", 
                           "healthcare") ),
            modalitymap = data.frame(
              variable = c( "shelter", "shelter",
                           "electricity",  "electricity", 
                           "drinkingwater", "drinkingwater", 
                           "healthcare","healthcare"),
              label = c( "Yes","No",
                       "Yes","No",
                       "Yes","No",
                       "Yes","No"),
              standard = c( "1","0",
                           "1","0",
                           "1","0",
                           "1","0"),
              map = c("1","0",
                           "1","0",
                           "1","0",
                           "1","0")))
 
datalist <-  impact_2_2(datalist, mapper)

fct_plot_indic_donut(indicator = datalist[["main"]]$impact2_2,
                     iconunicode = "f140") 
```

  

  


 


 

